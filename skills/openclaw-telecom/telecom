#!/bin/bash

# Configuration
API_URL="${TELECOM_API_URL:-https://telop.dev}"
API_TOKEN="${TELECOM_API_TOKEN:-sk_live_289347293847}"

# Helper for JSON Output
json_resp() {
    echo "$1"
}

case "$1" in
    status)
        curl -s -X GET "$API_URL/v1/status/recent" \
             -H "Content-Type: application/json" \
             -H "X-Workspace-Token: $API_TOKEN" \
             -H "X-Actor-Source: cli"
        ;;
    call)
        if [ "$2" == "dial" ]; then
            TO_NUM="$3"
            shift 3
            RECORD="false"
            TRANSCRIBE="false"
            
            while [[ "$#" -gt 0 ]]; do
                case $1 in
                    --record) RECORD="true" ;;
                    --transcribe) TRANSCRIBE="true" ;;
                    *) echo "Unknown parameter: $1"; exit 1 ;;
                esac
                shift
            done
            
            if [ -z "$TO_NUM" ]; then
                echo '{"error": "Missing argument: to_number"}'
                exit 1
            fi
            
            curl -s -X POST "$API_URL/v1/calls/dial" \
                 -H "Content-Type: application/json" \
                 -H "X-Workspace-Token: $API_TOKEN" \
                 -H "X-Actor-Source: cli" \
                 -d "{\"to\": \"$TO_NUM\", \"record\": $RECORD, \"transcribe\": $TRANSCRIBE}"
        elif [ "$2" == "merge" ]; then
            SID_A="$3"
            SID_B="$4"
             if [ -z "$SID_A" ] || [ -z "$SID_B" ]; then
                echo '{"error": "Missing argument: sidA or sidB"}'
                exit 1
            fi
            curl -s -X POST "$API_URL/v1/conferences/merge" \
                 -H "Content-Type: application/json" \
                 -H "X-Workspace-Token: $API_TOKEN" \
                 -H "X-Actor-Source: cli" \
                 -d "{\"callSidA\": \"$SID_A\", \"callSidB\": \"$SID_B\"}"
        else
            echo '{"error": "Unknown subcommand. Use: dial, merge"}'
            exit 1
        fi
        ;;
    sms)
        if [ "$2" == "send" ]; then
            TO_NUM="$3"
            MSG="$4"
            if [ -z "$TO_NUM" ] || [ -z "$MSG" ]; then
                echo '{"error": "Usage: sms send <to> <message>"}'
                exit 1
            fi
            curl -s -X POST "$API_URL/v1/sms/send" \
                 -H "Content-Type: application/json" \
                 -H "X-Workspace-Token: $API_TOKEN" \
                 -H "X-Actor-Source: cli" \
                 -d "{\"to\": \"$TO_NUM\", \"body\": \"$MSG\"}"
        fi
        ;;
    approve)
        ID="$2"
        if [ -z "$ID" ]; then echo '{"error": "Missing ID"}'; exit 1; fi
        curl -s -X POST "$API_URL/v1/approvals/$ID/decision" \
             -H "Content-Type: application/json" \
             -H "X-Workspace-Token: $API_TOKEN" \
             -H "X-Actor-Source: cli" \
             -d '{"decision": "approve"}'
        ;;
    deny)
        ID="$2"
        REASON="$3"
        if [ -z "$ID" ]; then echo '{"error": "Missing ID"}'; exit 1; fi
        curl -s -X POST "$API_URL/v1/approvals/$ID/decision" \
             -H "Content-Type: application/json" \
             -H "X-Workspace-Token: $API_TOKEN" \
             -H "X-Actor-Source: cli" \
             -d "{\"decision\": \"deny\", \"reason\": \"$REASON\"}"
        ;;
    setup)
        SID="$2"
        AUTH="$3"
        FROM="$4"
        
        # Interactive Mode
        if [ -z "$SID" ]; then
            echo "ðŸ“ž Telecom Operator Setup"
            read -p "Twilio Account SID: " SID
        fi
        if [ -z "$AUTH" ]; then
            read -p "Twilio Auth Token: " AUTH
        fi
        if [ -z "$FROM" ]; then
            read -p "Default From Number: " FROM
        fi

        if [ -z "$SID" ] || [ -z "$AUTH" ] || [ -z "$FROM" ]; then
             echo '{"error": "Aborted: Missing credentials"}'
             exit 1
        fi

        curl -s -X POST "$API_URL/v1/setup/provider" \
             -H "Content-Type: application/json" \
             -H "X-Workspace-Token: $API_TOKEN" \
             -H "X-Actor-Source: cli" \
             -d "{\"accountSid\": \"$SID\", \"authToken\": \"$AUTH\", \"fromNumber\": \"$FROM\"}"
        ;;
    release)
        SID="$2"
        if [ -z "$SID" ]; then echo '{"error": "Missing Call SID"}'; exit 1; fi
        curl -s -X POST "$API_URL/v1/calls/$SID/release" \
             -H "Content-Type: application/json" \
             -H "X-Workspace-Token: $API_TOKEN" \
             -H "X-Actor-Source: cli" \
             -d '{}'
        ;;
    help|*)
        echo "Telecom CLI v1.1.0"
        echo "Commands:"
        echo "  telecom status"
        echo "  telecom call dial <to> [--record] [--transcribe]"
        echo "  telecom call merge <sidA> <sidB>"
        echo "  telecom sms send <to> <msg>"
        echo "  telecom approve <id>"
        echo "  telecom deny <id> <reason>"
        echo "  telecom release <sid>"
        echo "  telecom setup <sid> <auth_token> <from_number>"
        ;;
esac
